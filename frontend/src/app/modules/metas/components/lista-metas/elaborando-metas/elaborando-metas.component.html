<div class="section">
  <div class="section-header">
    <h2>ELABORANDO AS METAS DO CASAL</h2>
  </div>

  <!-- Progress Bar Geral -->
  <div class="progress-container">
    <div class="progress-text">{{ percentualPagoView | number:'1.0-1' }}%</div>
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="percentualPagoView"></div>
    </div>
  </div>

  <div class="table-container">
    <!-- Botão Adicionar Meta -->
    <div class="add-meta-container">
      <button class="add-meta-btn" (click)="abrirModalAdicionarMeta()" [disabled]="metas.length >= 15">
        <span class="material-icons">add</span>
        Adicionar Meta
        <span class="meta-count">({{ metas.length }}/15)</span>
      </button>
    </div>

    <table class="metas-table">
      <thead>
        <tr>
          <th>QUAL É A META?</th>
          <th>VALOR DA META</th>
          <th>QUANTO POR MÊS?</th>
          <th>QUANTOS MESES?</th>
          <th>QUANTO JÁ TEMOS?</th>
          <th>PROGRESSO</th>
          <th>AÇÕES</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let meta of metas; trackBy: trackById; let i = index;" [class.alternate]="i % 2 === 1">
          <td class="col-nome" [attr.data-meta-id]="meta.id">
            <!-- Visual -->
            <ng-container *ngIf="!meta.editandoNome; else editNome">
              <button class="cell-btn" (click)="editarCampo(meta, 'nome')" title="Editar nome da meta">
                <span class="cell-text">{{ meta.nome || 'Defina um nome' }}</span>
                <span class="material-icons ok" *ngIf="meta.savedTickCampo === true">check_circle</span>
              </button>
            </ng-container>

            <!-- Edição -->
            <ng-template #editNome>
              <input class="cell-input input-nome" [(ngModel)]="meta.nomeTemp" (keyup)="onKeyUp($event, meta, 'nome')"
                (blur)="confirmarCampoBlur(meta, 'nome')" />
            </ng-template>
          </td>
          <td [attr.data-meta-id]="meta.id">
            <ng-container *ngIf="!meta.editandoValorMeta; else editValorMeta">
              <button class="cell-btn" (click)="editarCampo(meta, 'valorMeta')" title="Editar valor da meta">
                <span class="cell-text">{{ meta.valorMeta | currency:'BRL' }}</span>
                <span class="material-icons ok" *ngIf="meta.savedTickCampo === true">check_circle</span>
              </button>
            </ng-container>
            <ng-template #editValorMeta>
              <input class="cell-input input-valorMeta" [(ngModel)]="meta.valorMetaTemp" inputmode="decimal"
                (keyup)="onKeyUp($event, meta, 'valorMeta')" (blur)="confirmarCampoBlur(meta, 'valorMeta')" />
            </ng-template>
          </td>
          <td [attr.data-meta-id]="meta.id">
            <ng-container *ngIf="!meta.editandoValorPorMes; else editValorMes">
              <button class="cell-btn" (click)="editarCampo(meta, 'valorPorMes')" title="Editar contribuição mensal">
                <span class="cell-text">{{ meta.valorPorMes | currency:'BRL' }}</span>
                <span class="material-icons ok" *ngIf="meta.savedTickCampo === true">check_circle</span>
              </button>
            </ng-container>
            <ng-template #editValorMes>
              <input class="cell-input input-valorPorMes" [(ngModel)]="meta.valorPorMesTemp" inputmode="decimal"
                (keyup)="onKeyUp($event, meta, 'valorPorMes')" (blur)="confirmarCampoBlur(meta, 'valorPorMes')" />
            </ng-template>
          </td>
          <td>{{ getMesesRestantes(meta) === 0 ? 'Finalizado' : getMesesRestantes(meta) }}</td>
          <td [attr.data-meta-id]="meta.id">
            <ng-container *ngIf="!meta.editandoValorAtual; else editValorAtual">
              <button class="cell-btn" (click)="editarCampo(meta, 'valorAtual')" title="Editar quanto já temos">
                <span class="cell-text">{{ meta.valorAtual | currency:'BRL' }}</span>
                <span class="material-icons ok" *ngIf="meta.savedTickCampo === true">check_circle</span>
              </button>
            </ng-container>
            <ng-template #editValorAtual>
              <input class="cell-input input-valorAtual" [(ngModel)]="meta.valorAtualTemp" inputmode="decimal"
                (keyup)="onKeyUp($event, meta, 'valorAtual')" (blur)="confirmarCampoBlur(meta, 'valorAtual')" />
            </ng-template>
          </td>
          <td class="progress-cell">
            <div class="progress-info">
              <div class="progress-percentage">{{ getProgressoRealMeta(meta) | number:'1.0-1' }}%</div>
              <div class="progress-details">
                <div class="progress-realizado">Realizado: {{ getValorRealizadoMeta(meta) | currency:'BRL' }}</div>
                <div class="progress-faltante">Falta: {{ getValorFaltanteMeta(meta) | currency:'BRL' }}</div>
              </div>
            </div>
          </td>
          <td class="actions-cell">
            <button class="remove-meta-btn" (click)="removerMeta(meta.id)" [disabled]="metas.length <= 1 || !meta.id"
              title="Remover meta">
              <span class="material-icons">delete</span>
            </button>
          </td>
        </tr>
        <tr class="total-row">
          <td><strong>Total</strong></td>
          <td><strong>{{ totalValorMetaView | currency:'BRL' }}</strong></td>
          <td><strong>{{ totalValorPorMesView | currency:'BRL' }}</strong></td>
          <td><strong>{{ totalMesesNecessariosView }}</strong></td>
          <td><strong>{{ totalValorAtualView | currency:'BRL' }}</strong></td>
          <td><strong>{{ percentualPagoView | number:'1.0-1' }}%</strong></td>
          <td></td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal de Adicionar Meta -->
  <div class="modal-overlay" *ngIf="modalAdicionarMeta.isOpen" (click)="fecharModalAdicionarMeta()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Adicionar Nova Meta</h3>
        <button class="modal-close" (click)="fecharModalAdicionarMeta()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="modal-input-group">
          <label for="nome-nova-meta">Nome da Meta:</label>
          <input id="nome-nova-meta" type="text" autocomplete="off" [ngModel]="modalAdicionarMeta.nome"
            (ngModelChange)="modalAdicionarMeta.nome = $event" class="modal-input" placeholder="Digite o nome da meta"
            autofocus>
        </div>

        <div class="modal-input-group">
          <label for="valor-meta">Valor da Meta:</label>
          <input id="valor-meta" type="text" autocomplete="off" inputmode="decimal"
            [ngModel]="modalAdicionarMeta.valorMeta === 0 ? '' : modalAdicionarMeta.valorMeta"
            (ngModelChange)="onValorMetaChange($event)" (keydown.enter)="salvarMetaModal()"
            (keypress)="validarApenasNumeros($event)" class="modal-input" placeholder="0,00">
        </div>

        <div class="modal-input-group">
          <label for="valor-mes">Valor por Mês:</label>
          <input id="valor-mes" type="text" autocomplete="off" inputmode="decimal"
            [ngModel]="modalAdicionarMeta.valorPorMes === 0 ? '' : modalAdicionarMeta.valorPorMes"
            (ngModelChange)="onValorPorMesChange($event)" (keydown.enter)="salvarMetaModal()"
            (keypress)="validarApenasNumeros($event)" class="modal-input" placeholder="0,00">
        </div>

        <div class="modal-input-group">
          <label for="valor-atual">Valor Já Temos:</label>
          <input id="valor-atual" type="text" autocomplete="off" inputmode="decimal"
            [ngModel]="modalAdicionarMeta.valorAtual === 0 ? '' : modalAdicionarMeta.valorAtual"
            (ngModelChange)="onValorAtualChange($event)" (keydown.enter)="salvarMetaModal()"
            (keypress)="validarApenasNumeros($event)" class="modal-input" placeholder="0,00">
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancelar" (click)="cancelarAdicionarMeta()">
          Cancelar
        </button>
        <button class="btn-salvar" (click)="salvarMetaModal()">
          Adicionar
        </button>
      </div>
    </div>
  </div>

  <app-success-modal [isOpen]="modalSucessoAdd.isOpen" title="Meta adicionada!"
    message="Sua meta foi criada com sucesso." confirmText="Fechar" [autoCloseMs]="0"
    (close)="modalSucessoAdd.isOpen = false">
  </app-success-modal>

  <app-success-modal [isOpen]="modalSucessoDelete.isOpen" title="Meta removida!"
    message="A meta foi excluída com sucesso." confirmText="OK" [autoCloseMs]="0"
    (close)="modalSucessoDelete.isOpen = false">
  </app-success-modal>

  <!-- Modal de Confirmação de Exclusão -->
  <app-confirm-modal [isOpen]="modalConfirmarDelete.isOpen" title="Confirmar Exclusão"
    [message]="'Tem certeza que deseja excluir a meta \'' + (metaParaExcluir?.nome || '') + '\'?'"
    confirmText="Sim, Excluir" cancelText="Cancelar" (confirm)="confirmarExclusao()" (cancel)="cancelarExclusao()">
  </app-confirm-modal>

  <!-- Modal de Parabéns -->
  <app-parabens-modal [isOpen]="modalParabens.isOpen" [metaNome]="modalParabens.metaNome"
    [valorMeta]="modalParabens.valorMeta" (close)="fecharParabens()">
  </app-parabens-modal>
</div>
